<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Simple Map</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
        html, body, #viewDiv {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="viewDiv"></div>
    <script>
        require([
            "esri/config",
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/core/reactiveUtils",
            "esri/layers/support/FeatureReductionBinning",
            "esri/layers/support/AggregateField",
            "esri/layers/support/LabelClass"
        ], function(esriConfig, Map, MapView, FeatureLayer, reactiveUtils, FeatureReductionBinning, AggregateField, LabelClass) {
            esriConfig.apiKey = "AAPK76781a872cbc4f3586992bdb98501e2eangcJw2b7mb9HuZUOhY2gpytnsSM8fd8hV6sDjOMDBSbGdCpUA3oYKBRufAQEg4x";
            const map = new Map({
                basemap: "arcgis/streets-night" // You can change the basemap here.
            });

            const view = new MapView({
                container: "viewDiv", // This is the ID of the div where the map will be rendered.
                map: map,
                zoom: 11, // Sets zoom level based on scale
                center: [-122.3321, 47.6562], // Sets the center point of view in longitude,latitude
                constraints: {
                    minScale: 1155582,
                    snapToZoom: false
                }
            });

            const collisions = new FeatureLayer({
                url: "https://services.arcgis.com/ZOyb2t4B0UYuYNYH/arcgis/rest/services/SDOT_Collisions_All_Years/FeatureServer/0/query?outFields=*&where=1%3D1&f=geojson"
            });

            // Esri color ramps - Blue and Red 18
// #00aaffff,#0060a6ff,#403e3aff,#801921ff,#d92b2bff
            const colors = [
                "rgba(0, 170, 255, .3)",
                "rgba(0, 96, 166, .3)",
                "rgba(64, 62, 58, .3)",
                "rgba(128, 25, 33, .3)",
                "rgba(217, 43, 43, .3)"
            ];


            const heatmapRenderer = {
                // field: "INJURIES",
                type: "heatmap",
                colorStops: [
                { color: "rgba(255, 255, 255, 0)", ratio: 0 },    // Transparent for the lowest values
                { color: "rgba(255, 255, 204, 0.2)", ratio: 0.2 }, // Light yellow for low values
                { color: "rgba(255, 237, 160, 0.5)", ratio: 0.4 }, // Light orange for medium-low values
                { color: "rgba(254, 217, 118, 0.7)", ratio: 0.6 }, // Orange for medium values
                { color: "rgba(254, 178, 76, 0.8)", ratio: 0.8 },  // Dark orange for medium-high values
                { color: "rgba(253, 141, 60, 0.9)", ratio: 0.9 },  // Red-orange for high values
                { color: "rgba(240, 59, 32, 1)", ratio: 1 } 
                ],
                minDensity: 0,
                maxDensity: 0.319,
                radius: 10,
                referenceScale: 46000,
                
                legendOptions: {
                minLabel: "Low Collision Density",
                maxLabel: "High Collision Density"
              }
            };

            // heatmapRenderer.field = "INJURIES";

            collisions.renderer = heatmapRenderer;

            map.add(collisions);
            const layer = collisions;

            view.when().then(() => {
                // When the view is ready, clone the heatmap renderer
                // from the only layer in the web map

                const layer = collisions;
                // const heatmapRenderer = layer.renderer.clone();

                // The following simple renderer will render all points as simple
                // markers at certain scales

               
                // When the scale is larger than 1:72,224 (zoomed in passed that scale),
                // then switch from a heatmap renderer to a simple renderer. When zoomed
                // out beyond that scale, switch back to the heatmap renderer
                

                reactiveUtils.watch(
                    () => view.scale,
                    scale => {
                        console.log(scale);
                        if (scale < 60000) {
                            // Below 60000 zoom level - keep the heatmap static
                            heatmapRenderer.referenceScale = 0; // 0 disables static aspect
                            collisions.renderer = heatmapRenderer; // Apply updated renderer
                        } else {
                            // Above 46000 zoom level - make the heatmap static
                            heatmapRenderer.referenceScale = 46000; // Apply static aspect at this scale
                            collisions.renderer = heatmapRenderer; // Apply updated renderer
                        }

                        if (scale > 10000) { // When zoom level is less than 10000
                            layer.renderer = heatmapRenderer; // Use heatmap
                            layer.featureReduction = null; // Disable feature reduction
                        } else { // When zoom level is 10000 or more
                            layer.renderer = null; // Disable renderer to use default or set it to another if necessary
                            layer.featureReduction = { // Enable feature reduction
                                type: "binning",
                                fields: [
                                    new AggregateField({
                                        name: "aggregateCount",
                                        statisticType: "count"
                                    })
                                ],
                                fixedBinLevel: 8,
                                opacity: 50,
                                labelsVisible: true,
                                labelingInfo: [
                                    new LabelClass({
                                        minScale: 144448,
                                        maxScale: 0,
                                        deconflictionStrategy: "none",
                                        symbol: {
                                            type: "text",  // autocasts as new TextSymbol()
                                            color: "white",
                                            font: {
                                                family: "Noto Sans",
                                                size: 10,
                                                weight: "bold"
                                            },
                                            haloColor: colors[4],
                                            haloSize: 0.5
                                        },
                                        labelExpressionInfo: {
                                            expression: "Text($feature.aggregateCount, '#,###')"
                                        }
                                    })
                                ],
                                popupEnabled: true,
                                popupTemplate: {
                                    title: "Car crashes",
                                    content: "{aggregateCount} car crashes occurred in this area."
                                },
                                renderer: {
                                    type: "simple",
                                    symbol: {
                                        type: "simple-fill",
                                        color: [0, 255, 71],
                                        outline: {
                                            color: "rgba(153, 31, 23, 0.3)",
                                            width: 0.3
                                        }
                                    },
                                    visualVariables: [
                                        {
                                            type: "color",
                                            field: "aggregateCount",
                                            stops: [
                                                { value: 0, color: colors[0] },
                                                { value: 25, color: colors[1] },
                                                { value: 75, color: colors[2] },
                                                { value: 200, color: colors[3] },
                                                { value: 300, color: colors[4] }
                                            ]
                                        }
                                    ]
                                }
                            };
                        }
                    }
                );

            });
        })
    </script>
</body>
</html>